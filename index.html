<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FHIR Resources To Table</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 1rem;
      background-color: #f5f5f5;
    }

    h1 {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .form-group {
      display: grid;
      grid-template-columns: 1fr;
    }

    .form-group label {
      font-weight: bold;
    }

    #config {
      min-height: 300px;
    }


    .form-group input,
    .form-group textarea {
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    button {
      font-size: 1rem;
      font-weight: bold;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 5px;
      background-color: #4caf50;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #45a049;
    }

    #output {
      margin-top: 1rem;
      padding: 1rem;
      background-color: white;
      border-radius: 5px;
      overflow-x: auto;
    }

    @media (max-width: 600px) {
      .form-group {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <h1>FHIR Resource Processor</h1>
  <div class="form-group">
    <label for="url">URL:</label>
    <input type="text" id="url" name="url" />
  </div>
  <div class="form-group">
    <label for="file">File:</label>
    <input type="file" id="file" name="file" />
  </div>
  <div class="form-group">
    <label for="config">Config:</label>
    <textarea id="config" name="config" rows="10" cols="30">
{
  "resource": "Patient",
  "filter": [
    "Patient.gender = 'male'"
  ],
  "collections": {
    "pc": "Patient.contact",
    "pct": "%pc.telecom"
  },
  "columns": {
    "pid": "Patient.id",
    "cname": "%pc.name.text",
    "ctel": "%pct.value"
  }
 }
      </textarea>
  </div>
  <button id="process">Process</button>
  <pre id="output">out</pre>

  <script type="module">
    document.getElementById("process").addEventListener("click", async () => {
      const url = document.getElementById("url").value;
      const fileInput = document.getElementById("file");
      const configTextArea = document.getElementById("config");
      const output = document.getElementById("output");
      const config = JSON.parse(configTextArea.value);

      let resources;

      if (url) {
        resources = processResources(fetchResourcesFromUrl(url), config);
      } else if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        resources = processResources(readResourcesFromFile(file), config);
      } else {
        output.textContent = "Please provide a URL or a file.";
        return;
      }

      const result = [];
      for await (const row of resources) {
        result.push(row);
      }
      output.textContent = JSON.stringify(result, null, 2);
    });

    import fhirpath from "https://cdn.skypack.dev/fhirpath@v3.3.2";

    export async function* fetchResourcesFromUrl(url) {
      const response = await fetch(url);
      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let buffer = "";

      while (true) {
        const { value, done } = await reader.read();

        if (done) {
          // Process the remaining buffer content when done
          if (buffer) {
            yield JSON.parse(buffer);
          }
          break;
        }

        buffer += decoder.decode(value, { stream: true });

        const lines = buffer.split("\n");
        buffer = lines.pop(); // Keep the last (potentially incomplete) line in the buffer

        for (const line of lines) {
          if (!line) {
            continue;
          }

          yield JSON.parse(line);
        }
      }
    }

    export async function* readResourcesFromFile(file) {
      const text = await file.text();
      const lines = text.split("\n");

      for (const line of lines) {
        if (!line) {
          continue;
        }

        yield JSON.parse(line);
      }
    }

    export async function* processResources(resourceGenerator, config) {
      for await (const resource of resourceGenerator) {
        if (
          resource.resourceType === config.resource &&
          filterResource(resource, config)
        ) {
          const rowData = extractColumns(resource, config);
          for (const row of rowData) {
            yield row;
          }
        }
      }
    }

    function filterResource(resource, config) {
      return config.filter.every((expression) =>
        fhirpath.evaluate(resource, expression, null)
      );
    }

    function extractColumns(resource, config) {
      const collections = {};

      function* iterateCollections(collectionKeys, context = {}) {
        if (collectionKeys.length === 0) {
          const rowData = [];

          for (const key in config.columns) {
            const expression = config.columns[key];
            const value = fhirpath.evaluate(resource, expression, context);
            if (value.length > 1) {
              console.log("Expression returned >1 value", key, value);
            }
            rowData.push(value?.[0]);
          }

          yield rowData;
        } else {
          const currentKey = collectionKeys[0];
          const remainingKeys = collectionKeys.slice(1);
          const expression = config.collections[currentKey];
          const currentCollection = fhirpath.evaluate(
            resource,
            expression,
            context
          );

          for (const item of currentCollection) {
            console.log("i", item);
            const newContext = { ...context, [currentKey]: item };
            yield* iterateCollections(remainingKeys, newContext);
          }
        }
      }

      const collectionKeys = Object.keys(config.collections);
      const result = Array.from(iterateCollections(collectionKeys));

      return result;
    }

    const data = {
      text: () => `{ "resourceType" : "Patient", "id" : "example", "meta" : { "profile" : ["http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"] }, "extension" : [{ "extension" : [{ "url" : "ombCategory", "valueCoding" : { "system" : "urn:oid:2.16.840.1.113883.6.238", "code" : "2106-3", "display" : "White" } }, { "url" : "ombCategory", "valueCoding" : { "system" : "urn:oid:2.16.840.1.113883.6.238", "code" : "1002-5", "display" : "American Indian or Alaska Native" } }, { "url" : "ombCategory", "valueCoding" : { "system" : "urn:oid:2.16.840.1.113883.6.238", "code" : "2028-9", "display" : "Asian" } }, { "url" : "detailed", "valueCoding" : { "system" : "urn:oid:2.16.840.1.113883.6.238", "code" : "1586-7", "display" : "Shoshone" } }, { "url" : "detailed", "valueCoding" : { "system" : "urn:oid:2.16.840.1.113883.6.238", "code" : "2036-2", "display" : "Filipino" } }, { "url" : "text", "valueString" : "Mixed" }], "url" : "http://hl7.org/fhir/us/core/StructureDefinition/us-core-race" }, { "extension" : [{ "url" : "ombCategory", "valueCoding" : { "system" : "urn:oid:2.16.840.1.113883.6.238", "code" : "2135-2", "display" : "Hispanic or Latino" } }, { "url" : "detailed", "valueCoding" : { "system" : "urn:oid:2.16.840.1.113883.6.238", "code" : "2184-0", "display" : "Dominican" } }, { "url" : "detailed", "valueCoding" : { "system" : "urn:oid:2.16.840.1.113883.6.238", "code" : "2148-5", "display" : "Mexican" } }, { "url" : "text", "valueString" : "Hispanic or Latino" }], "url" : "http://hl7.org/fhir/us/core/StructureDefinition/us-core-ethnicity" }, { "extension" : [{ "url" : "tribalAffiliation", "valueCodeableConcept" : { "coding" : [{ "system" : "http://terminology.hl7.org/CodeSystem/v3-TribalEntityUS", "code" : "187", "display" : "Paiute-Shoshone Tribe of the Fallon Reservation and Colony, Nevada" }], "text" : "Shoshone" } }, { "url" : "isEnrolled", "valueBoolean" : false }], "url" : "http://hl7.org/fhir/us/core/StructureDefinition/us-core-tribal-affiliation" }, { "url" : "http://hl7.org/fhir/us/core/StructureDefinition/us-core-birthsex", "valueCode" : "F" }, { "url" : "http://hl7.org/fhir/us/core/StructureDefinition/us-core-genderIdentity", "valueCodeableConcept" : { "coding" : [{ "system" : "http://terminology.hl7.org/CodeSystem/v3-NullFlavor", "code" : "UNK", "display" : "Unknown" }], "text" : "Unknown" } }], "identifier" : [{ "use" : "usual", "type" : { "coding" : [{ "system" : "http://terminology.hl7.org/CodeSystem/v2-0203", "code" : "MR", "display" : "Medical Record Number" }], "text" : "Medical Record Number" }, "system" : "http://hospital.smarthealthit.org", "value" : "1032702" }], "active" : true, "name" : [{ "use" : "old", "family" : "Shaw", "given" : ["Amy", "V."], "period" : { "start" : "2016-12-06", "end" : "2020-07-22" } }, { "family" : "Baxter", "given" : ["Amy", "V."], "suffix" : ["PharmD"], "period" : { "start" : "2020-07-22" } }], "telecom" : [{ "system" : "phone", "value" : "555-555-5555", "use" : "home" }, { "system" : "email", "value" : "amy.shaw@example.com" }], "gender" : "female", "birthDate" : "1987-02-20", "address" : [{ "use" : "old", "line" : ["49 Meadow St"], "city" : "Mounds", "state" : "OK", "postalCode" : "74047", "country" : "US", "period" : { "start" : "2016-12-06", "end" : "2020-07-22" } }, { "line" : ["183 Mountain View St"], "city" : "Mounds", "state" : "OK", "postalCode" : "74048", "country" : "US", "period" : { "start" : "2020-07-22" } }], "contact": [{"name": {"text": "Alice"}, "telecom": {"value": "617-500-0000"}}, {"name": {"text": "Bob"}, "telecom": {"value": "617-500-0001"}}] }
{ "resourceType" : "Patient", "id" : "example", "meta" : { "profile" : ["http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"] }, "extension" : [{ "extension" : [{ "url" : "ombCategory", "valueCoding" : { "system" : "urn:oid:2.16.840.1.113883.6.238", "code" : "2106-3", "display" : "White" } }, { "url" : "ombCategory", "valueCoding" : { "system" : "urn:oid:2.16.840.1.113883.6.238", "code" : "1002-5", "display" : "American Indian or Alaska Native" } }, { "url" : "ombCategory", "valueCoding" : { "system" : "urn:oid:2.16.840.1.113883.6.238", "code" : "2028-9", "display" : "Asian" } }, { "url" : "detailed", "valueCoding" : { "system" : "urn:oid:2.16.840.1.113883.6.238", "code" : "1586-7", "display" : "Shoshone" } }, { "url" : "detailed", "valueCoding" : { "system" : "urn:oid:2.16.840.1.113883.6.238", "code" : "2036-2", "display" : "Filipino" } }, { "url" : "text", "valueString" : "Mixed" }], "url" : "http://hl7.org/fhir/us/core/StructureDefinition/us-core-race" }, { "extension" : [{ "url" : "ombCategory", "valueCoding" : { "system" : "urn:oid:2.16.840.1.113883.6.238", "code" : "2135-2", "display" : "Hispanic or Latino" } }, { "url" : "detailed", "valueCoding" : { "system" : "urn:oid:2.16.840.1.113883.6.238", "code" : "2184-0", "display" : "Dominican" } }, { "url" : "detailed", "valueCoding" : { "system" : "urn:oid:2.16.840.1.113883.6.238", "code" : "2148-5", "display" : "Mexican" } }, { "url" : "text", "valueString" : "Hispanic or Latino" }], "url" : "http://hl7.org/fhir/us/core/StructureDefinition/us-core-ethnicity" }, { "extension" : [{ "url" : "tribalAffiliation", "valueCodeableConcept" : { "coding" : [{ "system" : "http://terminology.hl7.org/CodeSystem/v3-TribalEntityUS", "code" : "187", "display" : "Paiute-Shoshone Tribe of the Fallon Reservation and Colony, Nevada" }], "text" : "Shoshone" } }, { "url" : "isEnrolled", "valueBoolean" : false }], "url" : "http://hl7.org/fhir/us/core/StructureDefinition/us-core-tribal-affiliation" }, { "url" : "http://hl7.org/fhir/us/core/StructureDefinition/us-core-birthsex", "valueCode" : "F" }, { "url" : "http://hl7.org/fhir/us/core/StructureDefinition/us-core-genderIdentity", "valueCodeableConcept" : { "coding" : [{ "system" : "http://terminology.hl7.org/CodeSystem/v3-NullFlavor", "code" : "UNK", "display" : "Unknown" }], "text" : "Unknown" } }], "identifier" : [{ "use" : "usual", "type" : { "coding" : [{ "system" : "http://terminology.hl7.org/CodeSystem/v2-0203", "code" : "MR", "display" : "Medical Record Number" }], "text" : "Medical Record Number" }, "system" : "http://hospital.smarthealthit.org", "value" : "1032702" }], "active" : true, "name" : [{ "use" : "old", "family" : "Shaw", "given" : ["Amy", "V."], "period" : { "start" : "2016-12-06", "end" : "2020-07-22" } }, { "family" : "Baxter", "given" : ["Amy", "V."], "suffix" : ["PharmD"], "period" : { "start" : "2020-07-22" } }], "telecom" : [{ "system" : "phone", "value" : "555-555-5555", "use" : "home" }, { "system" : "email", "value" : "amy.shaw@example.com" }], "gender" : "female", "birthDate" : "1987-02-20", "address" : [{ "use" : "old", "line" : ["49 Meadow St"], "city" : "Mounds", "state" : "OK", "postalCode" : "74047", "country" : "US", "period" : { "start" : "2016-12-06", "end" : "2020-07-22" } }, { "line" : ["183 Mountain View St"], "city" : "Mounds", "state" : "OK", "postalCode" : "74048", "country" : "US", "period" : { "start" : "2020-07-22" } }], "contact": [{"name": {"text": "Alice"}, "telecom": {"value": "617-500-0000"}}, {"name": {"text": "Bob"}, "telecom": {"value": "617-500-0001"}}] }
`,
    };
    const testConfig = {
      resource: "Patient",
      filter: ["Patient.gender = 'male'"],
      collections: {
        pc: "Patient.contact",
        pct: "%pc.telecom",
      },
      columns: {
        pid: "Patient.id",
        cname: "%pc.name.text",
        ctel: "%pct.value",
      },
    };
    const resources = await processResources(
      readResourcesFromFile(data),
      testConfig
    );

    console.log(resources);
  </script>
</body>

</html>